{% extends 'base.html' %}
{% block content %}
<h2>ğŸ“˜ ì£¼ê°„ë³´ê³  ì‘ì„±</h2>

<form method="post" action="{{ url_for('report.edit_report') }}">
  <!-- Hidden ID -->
  <input type="hidden" name="report_id" value="{{ report.id }}">

  <!-- ğŸ”¹ Project Section -->
  <section>
    <h3>ğŸ“ í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸</h3>
    <button type="button" onclick="openProjectModal()">+ í”„ë¡œì íŠ¸ ì¶”ê°€</button>
    <div id="project-list">
      <!-- Populated dynamically -->
    </div>
  </section>

  <!-- ğŸ”¹ Personal Schedule Section -->
  <section style="margin-top: 2rem;">
    <h3>ğŸ—“ï¸ ê°œì¸ ì¼ì •</h3>
    <button type="button" onclick="addSchedule()">+ ì¼ì • ì¶”ê°€</button>
    <div id="schedule-list">
      <!-- Dynamically appended schedule blocks -->
    </div>
  </section>

  <br>
  <button type="submit">ì œì¶œ</button>
</form>

<!-- ğŸ”³ Project Modal -->
<div id="projectModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>í”„ë¡œì íŠ¸ ì„ íƒ</h3>
    <label><input type="checkbox" id="toggleAllProjects" onchange="toggleProjectList()"> ëª¨ë“  í”„ë¡œì íŠ¸ ë³´ê¸°</label>
    <ul id="projectOptions">
      <!-- Populated via JS -->
    </ul>
    <button type="button" onclick="addSelectedProjects()">ì¶”ê°€</button>
    <button type="button" onclick="closeProjectModal()">ë‹«ê¸°</button>
  </div>
</div>

<style>
  .modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    max-height: 80vh;
    overflow-y: auto;
  }
</style>

<script>
  const allProjects = {{ all_projects | tojson }};
  const assignedProjects = {{ assigned_projects | tojson }};
  const addedProjectIds = new Set();

  function openProjectModal() {
    document.getElementById("projectModal").style.display = "flex";
    populateProjectList(false);
  }

  function closeProjectModal() {
    document.getElementById("projectModal").style.display = "none";
  }

  function toggleProjectList() {
    const showAll = document.getElementById("toggleAllProjects").checked;
    populateProjectList(showAll);
  }

  function populateProjectList(showAll) {
    const container = document.getElementById("projectOptions");
    container.innerHTML = "";
    const list = showAll ? allProjects : assignedProjects;

    list.forEach(p => {
      if (!addedProjectIds.has(p.id)) {
        const li = document.createElement("li");
        li.innerHTML = `
          <label>
            <input type="checkbox" value="${p.id}">
            [${p.solution_name}] ${p.project_name}
          </label>
        `;
        container.appendChild(li);
      }
    });
  }

  function addSelectedProjects() {
    const checkboxes = document.querySelectorAll("#projectOptions input[type='checkbox']:checked");
    checkboxes.forEach(cb => {
      const projectId = parseInt(cb.value);
      const project = allProjects.find(p => p.id === projectId);
      if (project && !addedProjectIds.has(projectId)) {
        addedProjectIds.add(projectId);
        const container = document.getElementById("project-list");
        const wrapper = document.createElement("div");
        wrapper.classList.add("project-block");
        wrapper.innerHTML = `
          <hr><h4>${project.solution_name} - ${project.project_name}</h4>
          <input type="hidden" name="project_id[]" value="${project.id}">
          <label>ì§„í–‰ìƒí™©</label>
          <textarea name="progress[]"></textarea>
          <label>íŠ¹ì´ì‚¬í•­</label>
          <textarea name="issue[]"></textarea>
          <label>ì˜ì—…ì§€ì› ì‚¬í•­</label>
          <textarea name="sales_support[]"></textarea>
          <label>ê·¸ ì™¸ íŠ¹ì´ì‚¬í•­</label>
          <textarea name="other_note[]"></textarea>
        `;
        container.appendChild(wrapper);
      }
    });
    closeProjectModal();
  }

  function addSchedule() {
    const container = document.getElementById("schedule-list");
    const idx = container.children.length;

    const wrapper = document.createElement("div");
    wrapper.classList.add("schedule-block");
    wrapper.innerHTML = `
      <hr>
      <label>êµ¬ë¶„</label>
      <select name="schedule_category[]">
        <option value="ì¶œì¥">ì¶œì¥</option>
        <option value="ì™¸ê·¼">ì™¸ê·¼</option>
        <option value="íœ´ê°€">íœ´ê°€</option>
        <option value="íœ´ì¼ê·¼ë¬´">íœ´ì¼ê·¼ë¬´</option>
      </select>
      <label>ì œëª©</label>
      <input type="text" name="schedule_title[]">
      <label>ì¥ì†Œ</label>
      <input type="text" name="schedule_location[]">
      <label>ì‹œì‘ì¼</label>
      <input type="date" name="schedule_start_date[]">
      <label>ì¢…ë£Œì¼</label>
      <input type="date" name="schedule_end_date[]">
      <label>ë¹„ê³ </label>
      <input type="text" name="schedule_description[]">
    `;
    container.appendChild(wrapper);
  }
</script>

{% endblock %}
