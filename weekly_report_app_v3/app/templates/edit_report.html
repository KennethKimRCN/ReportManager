{% extends 'base.html' %}

{% block title %}Edit Report{% endblock %}

{% block content %}
<h2>{{ report.user.name }}'s Y{{ report.year }} W{{ report.week }} Weekly Report - ID: {{ report.id }}</h2>
<p>Status: {{ report.status }}</p>

<form method="POST">
  <button type="button" id="add-solution-btn">Add Solution</button><br><br>

  <div id="solution-container">
    {% for item in existing_updates %}
    <div class="solution-wrapper" style="margin-bottom: 12px; border: 1px solid #ccc; padding: 10px;">
      <div class="solution-row">
        <button type="button" class="remove-solution">X</button>
        <label class="solution-label">솔루션: {{ item.solution_name }}</label>
        <input type="hidden" name="solution_item_ids[]" value="{{ item.solution_id }}">
        <button type="button" class="add-project">Add Project</button>
      </div>

      <div class="project-wrapper" style="margin-top: 10px; border: 1px solid #ddd; padding: 10px;">
        <div>
          프로젝트: {{ item.solution_name }} / {{ item.location }} / {{ item.company }} /
          {{ item.project_name }} / {{ item.code }} / {{ item.assignees | map(attribute='name') | join(', ') }}
        </div>
        <input type="hidden" name="project_ids[]" value="{{ item.project_id }}">
        <button type="button" class="remove-project">Remove Project</button>

        <div class="project-details" style="margin-top: 10px;">
          <label>Schedule:
            <textarea name="schedules[]" rows="2" class="form-control">{{ item.schedule }}</textarea>
          </label><br>
          <label>Progress:
            <textarea name="progresses[]" rows="2" class="form-control" required>{{ item.progress }}</textarea>
          </label><br>
          <label>Issue:
            <textarea name="issues[]" rows="2" class="form-control">{{ item.issue }}</textarea>
          </label>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <button type="submit">Update Report</button>
</form>

<!-- Templates -->
<template id="solution-template">
  <div class="solution-wrapper" style="margin-bottom: 12px; border: 1px solid #ccc; padding: 10px;">
    <div class="solution-row">
      <button type="button" class="remove-solution">X</button>
      <label class="solution-label">솔루션: <span class="selected-solution-name"></span></label>
      <input type="hidden" name="solution_item_ids[]" class="solution-id">
      <button type="button" class="add-project">Add Project</button>
    </div>
  </div>
</template>

<template id="project-template">
  <div class="project-wrapper" style="margin-top: 10px; border: 1px solid #ddd; padding: 10px;">
    <div class="project-info">
      <strong>프로젝트:</strong>
      <span class="project-solution-name"></span> /
      <span class="project-location"></span> /
      <span class="project-company"></span> /
      <span class="project-name"></span> /
      <span class="project-code"></span> /
      <span class="project-assignees"></span>
    </div>

    <input type="hidden" name="project_ids[]" class="project-id">
    <button type="button" class="remove-project">Remove Project</button>

    <div class="project-details" style="margin-top: 10px;">
      <label>Schedule:
        <textarea name="schedules[]" rows="2" class="form-control"></textarea>
      </label><br>
      <label>Progress:
        <textarea name="progresses[]" rows="2" class="form-control" required></textarea>
      </label><br>
      <label>Issue:
        <textarea name="issues[]" rows="2" class="form-control"></textarea>
      </label>
    </div>
  </div>
</template>

<!-- Solution Modal -->
<div id="solution-modal" class="modal">
  <div class="modal-content">
    <h3>Select a Solution</h3>
    <table id="solution-table">
      <thead>
        <tr><th>ID</th><th>Solution Name</th></tr>
      </thead>
      <tbody>
        {% for sol in solution_items %}
        <tr class="solution-row" data-id="{{ sol.id }}" data-name="{{ sol.name }}">
          <td>{{ sol.id }}</td>
          <td>{{ sol.name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button id="cancel-add-solution">Cancel</button>
  </div>
</div>

<!-- Project Modal -->
<div id="project-modal" class="modal">
  <div class="modal-content">
    <h3>Select a Project</h3>
    <table id="project-table">
      <thead>
        <tr><th>ID</th><th>Location</th><th>Company</th><th>Project Name</th><th>Code</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="cancel-project-selection">Cancel</button>
  </div>
</div>

<script>
  const solutionItems = {{ solution_items | tojson }};
  const projectsBySolution = {{ projects_by_solution | tojson }};
</script>
<script src="{{ url_for('static', filename='edit_report.js') }}"></script>
{% endblock %}
